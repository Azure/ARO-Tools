$schema: pipeline.schema.v1
buildStep:
  args:
  - build
  command: make
resourceGroups:
- executionConstraints:
  - clouds:
    - ff
    - usnat
    environments:
    - int
    - stg
    singleton: true
  - clouds:
    - public
    environments:
    - prod
    regions:
    - uksouth
    singleton: false
  name: regional
  resourceGroup: hcp-underlay-uks
  steps:
  - action: Shell
    adoArtifacts:
    - adoProject: adoProject
      artifactName: artifactName
      buildId: "12345"
      fileSourceToDestination:
        path/in/artifact/file1.txt: local/path/file1.txt
    aksCluster: aro-hcp-aks
    command: make deploy
    dryRun: {}
    name: deploy
    shellIdentity:
      configRef: aroDevopsMsiId
    subnetName: subnet
    variables:
    - configRef: maestro_image
      name: MAESTRO_IMAGE
  - action: Shell
    command: make deploy
    dryRun:
      variables:
      - name: DRY_RUN
        value: A very dry one
      - name: FROM_EV2_REGION
        value: "3"
      - name: FROM_EV2_CORE
        value: vault.azure.net
    name: dry-run
    shellIdentity:
      configRef: aroDevopsMsiId
    workingDir: something
  - action: ARM
    deploymentLevel: ResourceGroup
    name: svc
    parameters: test.bicepparam
    template: templates/svc-cluster.bicep
    variables:
    - input:
        name: whatever
        resourceGroup: regional
        step: deploy
      name: MAESTRO_IMAGE
  - action: ARMStack
    actionOnUnmanage: delete
    deploymentLevel: ResourceGroup
    name: svc-stack
    omitFromServiceGroupCompletion: true
    parameters: test.bicepparam
    template: templates/svc-cluster.bicep
    variables:
    - input:
        name: whatever
        resourceGroup: regional
        step: deploy
      name: MAESTRO_IMAGE
  - action: DelegateChildZone
    childZone:
      configRef: childZone
    dependsOn:
    - resourceGroup: regional
      step: deploy
    dstsHost:
      configRef: ev2.assistedId.dstsHost
    externalDependsOn:
    - resourceGroup: regional
      serviceGroup: Microsoft.Azure.ARO.Classic.Whatever
      step: deploy
    name: cxChildZone
    parentZone:
      configRef: parentZone
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
  - action: SetCertificateIssuer
    applicationId:
      configRef: ev2.assistedId.applicationId
    dependsOn:
    - resourceGroup: regional
      step: deploy
    issuer:
      configRef: provider
    name: issuerTest
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    vaultBaseUrl:
      configRef: vaultBaseUrl
  - action: SetCertificateIssuer
    applicationId:
      configRef: ev2.assistedId.applicationId
    dependsOn:
    - resourceGroup: regional
      step: deploy
    issuer:
      value: provider
    name: issuerTestOutputChaining
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    vaultBaseUrl:
      input:
        name: kvUrl
        resourceGroup: regional
        step: deploy
  - action: CreateCertificate
    applicationId:
      configRef: ev2.assistedId.applicationId
    certificateName:
      value: hcp-mdsd
    commonName:
      value: hcp-mdsd.geneva.keyvault.aro-int.azure.com
    contentType:
      value: x-pem-file
    issuer:
      value: OneCertV2-PrivateCA
    name: cert
    san:
      value: hcp-mdsd.geneva.keyvault.aro-int.azure.com
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    vaultBaseUrl:
      value: https://arohcp-svc-ln.vault.azure.net
  - action: ResourceProviderRegistration
    name: rpRegistration
    resourceProviderNamespaces:
      value:
      - Microsoft.Storage
      - Microsoft.EventHub
      - Microsoft.Insights
  - accountName:
      configRef: geneva.logs.rp.accountName
    action: RPLogsAccount
    adminAlias:
      configRef: geneva.logs.administrators.alias
    adminGroup:
      configRef: geneva.logs.administrators.securityGroup
    certdescription:
      value: HCP Service Cluster
    certsan:
      value: san
    configVersion:
      value: version
    database: {}
    environment:
      configRef: geneva.logs.environment
    eventSources:
      akskubesystem:
        name: kubesystem
    metricsAccount:
      configRef: geneva.metrics.rp.account
    monikerDefaultRegion: {}
    name: rpAccountOld
    namespace:
      value: ns
    rolloutKind: FluentBit
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    subscriptionId:
      value: sub
    typeName:
      configRef: geneva.logs.typeName
  - accountName:
      configRef: geneva.logs.rp.accountName
    action: RPLogsAccount
    adminAlias:
      configRef: geneva.logs.administrators.alias
    adminGroup:
      configRef: geneva.logs.administrators.securityGroup
    certdescription:
      value: HCP Service Cluster
    certsan:
      value: san
    configVersion:
      value: version
    database: {}
    environment:
      configRef: geneva.logs.environment
    eventSources:
      akskubesystem:
        account: kubesystemAccount
        name: kubesystem
    metricsAccount:
      configRef: geneva.metrics.rp.account
    monikerDefaultRegion: {}
    name: rpAccount
    namespace:
      value: ns
    rolloutKind: FluentBit
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    subscriptionId:
      value: sub
    typeName:
      configRef: geneva.logs.typeName
  - accountName:
      configRef: geneva.logs.cluster.accountName
    action: ClusterLogsAccount
    adminAlias:
      configRef: geneva.logs.administrators.alias
    adminGroup:
      configRef: geneva.logs.administrators.securityGroup
    certdescription:
      value: HCP Management Cluster
    certsan:
      value: san
    configVersion:
      value: version
    database: {}
    environment:
      configRef: geneva.logs.environment
    eventSources:
      akskubesystem:
        name: kubesystem
    metricsAccount:
      configRef: geneva.metrics.cluster.account
    monikerDefaultRegion: {}
    name: clusterAccount
    namespace:
      value: ns
    rolloutKind: FluentBit
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    subscriptionId:
      value: sub
    typeName:
      configRef: geneva.logs.typeName
  - accountName:
      configRef: geneva.logs.cluster.accountName
    action: RPLogsAccount
    adminAlias:
      configRef: geneva.logs.administrators.alias
    adminGroup:
      configRef: geneva.logs.administrators.securityGroup
    certdescription: {}
    certsan: {}
    configVersion: {}
    database:
      value: database
    environment:
      configRef: geneva.logs.environment
    metricsAccount:
      configRef: geneva.metrics.cluster.account
    monikerDefaultRegion:
      value: region
    name: rpAccountSetup
    namespace:
      value: ns
    rolloutKind: AccountSetup
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    subscriptionId:
      value: sub
    typeName: {}
  - action: ImageMirror
    digest:
      value: digest
    imageFilePath: {}
    imageMetadataFileName: {}
    imageTarFileName: {}
    name: image-mirror
    pullSecretKeyVault:
      value: pullSecretKeyVault
    pullSecretName:
      value: pullSecretName
    repository:
      value: repository
    shellIdentity:
      value: shellIdentity
    sourceRegistry:
      value: sourceRegistry
    targetACR:
      value: targetACR
  subscription: hcp-int-svc-uksouth
  subscriptionProvisioning:
    airsRegisteredUserPrincipalId:
      configRef: svc.subscription.airsRegisteredUserPrincipalId
    certificateDomains:
      configRef: svc.subscription.certificateDomains
    displayName:
      configRef: svc.subscription.displayName
    roleAssignment: test.bicepparam
- name: kusto
  resourceGroup: aro-kusto-public-int-us
  steps:
  - action: ARM
    deploymentLevel: ResourceGroup
    name: kusto-lookup
    outputOnly: true
    parameters: test.bicepparam
    template: templates/kusto-lookup.bicep
  subscription: hcp-uksouth
- name: global
  resourceGroup: global
  steps:
  - action: ProviderFeatureRegistration
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    name: register-providers-afec-flags
    providerConfigRef: svc.subscription.displayName
  - action: FeatureRegistration
    name: register-providers-feature-flags
    providerConfigRef: svc.subscription.displayName
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
  - action: Ev2Registration
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    name: register-ev2-services
  - action: SecretSync
    configurationFile: data/encryptedsecrets/config.yaml
    encryptionKey: secretSyncKey
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    keyVault: arohcpint-global
    name: sync-secrets
  - action: ImageMirror
    automatedRetry:
      durationBetweenRetries: 1h
      errorContainsAny:
      - Transient error
      maximumRetryCount: 8
    digest:
      value: digest
    imageFilePath: {}
    imageMetadataFileName: {}
    imageTarFileName: {}
    name: image-mirror
    pullSecretKeyVault:
      value: pullSecretKeyVault
    pullSecretName:
      value: pullSecretName
    repository:
      value: repository
    shellIdentity:
      value: shellIdentity
    sourceRegistry:
      value: sourceRegistry
    targetACR:
      value: targetACR
  - action: ImageMirror
    adoProject: adoProject
    artifactName: artifactName
    buildId: "12345"
    copyFrom: oci-layout
    digest: {}
    imageFilePath:
      value: path/to/image-tar-file
    imageMetadataFileName:
      value: image-metadata-file-name
    imageTarFileName:
      value: image-tar-file-name
    name: image-mirror-oci-layout
    pullSecretKeyVault: {}
    pullSecretName: {}
    repository:
      value: repository
    shellIdentity:
      value: shellIdentity
    sourceRegistry: {}
    targetACR:
      value: targetACR
  - action: Pav2
    name: pav2
    operation: All
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
    smeAppidParameter:
      input:
        name: kvUrl
        resourceGroup: regional
        step: deploy
    smeEndpointSuffixParameter:
      configRef: storage.storageSuffix
    storageAccount:
      configRef: storage.accountName
  - action: Helm
    aksCluster: whatever
    chartDir: chart
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    inputVariables:
      important:
        name: whatever
        resourceGroup: regional
        step: deploy
      other:
        name: whatever
        resourceGroup: regional
        step: deploy
    kustoDatabase: containerLogs
    kustoEndpoint:
      name: kustoUri
      resourceGroup: kusto
      step: kusto-lookup
    kustoTable: tableNameTest
    name: workload
    namespaceFiles:
    - additional-ns.yaml
    releaseName: workload
    releaseNamespace: kube-system
    rollbackOnFailure: true
    timeout: 1h
    valuesFile: values.yaml
  - action: PublishGenevaAction
    gaExtensionName:
      value: extensionName
    gaPackagePath: path/to/package
    genevaActionArtifact:
      adoProject: myproject
      artifactName: myartifact
      buildId: "12345"
    name: publishGA
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    secretName:
      configRef: ev2.assistedId.certificate.name
  - action: GenevaHealth
    configPackagePath: geneva-configs.zip
    genevaConfigsArtifact:
      adoProject: myproject
      artifactName: myartifact
      buildId: "12345"
      fileSourceToDestination:
        geneva-configs.zip: geneva-configs.zip
    monitorConfigPath: MonitorsV2
    monitoringAccountName:
      configRef: geneva.metrics.rp.account
    name: deployMonitors
    secretKeyVault:
      configRef: geneva.logs.accountCert.keyVault
    secretName:
      configRef: geneva.monitors.rpCert.name
  - action: PublishGenevaAutomation
    genevaAutomationArtifact:
      adoProject: myproject
      artifactName: automation-artifact
      buildId: "67890"
      fileSourceToDestination:
        workflow.zip: workflow.zip
    genevaAutomationSecretName:
      value: secretName
    icmServiceId:
      value: "12345"
    kustoClientSecretName:
      configRef: ev2.assistedId.certificate.name
    name: publishGenevaAutomation
    secretKeyVault:
      configRef: ev2.assistedId.certificate.keyVault
    workflowPath: path/to/workflow
  - action: GrafanaDashboards
    grafanaName:
      name: whatever
      resourceGroup: regional
      step: deploy
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    name: dashboards
    observabilityConfig: ./observability.yaml
  subscription: hcp-uksouth
  subscriptionProvisioning:
    displayName:
      configRef: svc.subscription.displayName
    roleAssignment: test.bicepparam
  validationSteps:
  - action: ProwJob
    gatePromotion: true
    identityFrom:
      name: whatever
      resourceGroup: regional
      step: deploy
    jobName: test-me
    name: e2e
    tokenKeyvault: arohcpint-global.vault.azure.net
    tokenSecret: prow-token
    validation:
    - Internal
rolloutName: Test Rollout
serviceGroup: Microsoft.Azure.ARO.Test
