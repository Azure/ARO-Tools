{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "pipeline.schema.v1",
  "type": "object",
  "additionalProperties": false,
  "definitions": {
    "stepReference": {
      "type": "object",
      "properties": {
        "resourceGroup": {
          "type": "string",
          "minLength": 1
        },
        "step": {
          "type": "string",
          "minLength": 1
        }
      },
      "required": [
        "resourceGroup",
        "step"
      ]
    },
    "stepDependencies": {
      "type": "array",
      "items": {
        "$ref": "#/definitions/stepReference"
      },
      "minLength": 1
    },
    "configRef": {
      "type": "string",
      "minLength": 1,
      "pattern": "[a-zA-Z0-9]+(\\.[a-zA-Z0-9]+)*"
    },
    "staticVariableValue": {
      "oneOf": [
        {
          "type": "string",
          "minLength": 1
        },
        {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      ]
    },
    "stepName": {
      "type": "string",
      "minLength": 1,
      "maxLength": 34,
      "pattern": "[a-zA-Z0-9\\-]{1,34}"
    },
    "input": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "resourceGroup": {
          "type": "string",
          "minLength": 1
        },
        "step": {
          "type": "string",
          "minLength": 1
        },
        "name": {
          "type": "string",
          "minLength": 1
        }
      },
      "required": [
        "resourceGroup",
        "step",
        "name"
      ]
    },
    "value": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "input": {
          "$ref": "#/definitions/input"
        },
        "configRef": {
          "$ref": "#/definitions/configRef"
        },
        "value": {
          "$ref": "#/definitions/staticVariableValue"
        }
      },
      "oneOf": [
        {
          "required": [
            "input"
          ]
        },
        {
          "required": [
            "configRef"
          ]
        },
        {
          "required": [
            "value"
          ]
        }
      ]
    },
    "variable": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1
        },
        "input": {
          "$ref": "#/definitions/input"
        },
        "configRef": {
          "$ref": "#/definitions/configRef"
        },
        "value": {
          "$ref": "#/definitions/staticVariableValue"
        }
      },
      "oneOf": [
        {
          "required": [
            "name",
            "input"
          ]
        },
        {
          "required": [
            "name",
            "configRef"
          ]
        },
        {
          "required": [
            "name",
            "value"
          ]
        }
      ],
      "required": [
        "name"
      ]
    },
    "executionConstraint": {
      "type": "object",
      "properties": {
        "singleton": {
          "type": "boolean"
        },
        "clouds": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "public",
              "ff",
              "mc",
              "usnat",
              "ussec",
              "bleu"
            ]
          }
        },
        "environments": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "int",
              "stg",
              "prod"
            ]
          }
        },
        "regions": {
          "type": "array",
          "items": {
            "type": "string",
            "minLength": 1
          }
        }
      }
    }
  },
  "properties": {
    "$schema": {
      "type": "string"
    },
    "serviceGroup": {
      "type": "string",
      "minLength": 1
    },
    "rolloutName": {
      "type": "string",
      "minLength": 1
    },
    "resourceGroups": {
      "type": "array",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "properties": {
          "name": {
            "type": "string",
            "minLength": 1,
            "maxLength": 12,
            "pattern": "[a-zA-Z0-9\\-]{1,12}"
          },
          "resourceGroup": {
            "type": "string",
            "minLength": 1
          },
          "subscription": {
            "type": "string",
            "minLength": 1
          },
          "executionConstraints": {
            "type": "array",
            "items": {
              "$ref": "#/definitions/executionConstraint"
            }
          },
          "subscriptionProvisioning": {
            "type": "object",
            "additionalProperties": false,
            "properties": {
              "displayName": {
                "$ref": "#/definitions/value"
              },
              "airsRegisteredUserPrincipalId": {
                "$ref": "#/definitions/value"
              },
              "certificateDomains": {
                "$ref": "#/definitions/value"
              },
              "backfillSubscriptionId": {
                "$ref": "#/definitions/value"
              },
              "roleAssignment": {
                "type": "string",
                "minLength": 1
              }
            },
            "anyOf": [
              {
                "required": [
                  "backfillSubscriptionId"
                ]
              },
              {
                "required": [
                  "displayName",
                  "roleAssignment"
                ]
              }
            ]
          },
          "steps": {
            "type": "array",
            "items": {
              "type": "object",
              "oneOf": [
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "ARM"
                    },
                    "template": {
                      "type": "string"
                    },
                    "parameters": {
                      "type": "string"
                    },
                    "variables": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/variable"
                      }
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    },
                    "deploymentLevel": {
                      "type": "string",
                      "enum": [
                        "ResourceGroup",
                        "Subscription"
                      ]
                    },
                    "deploymentMode": {
                      "type": "string",
                      "enum": [
                        "incremental",
                        "complete"
                      ]
                    },
                    "outputOnly": {
                      "type": "boolean"
                    }
                  },
                  "required": [
                    "template",
                    "parameters",
                    "deploymentLevel"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "Shell"
                    },
                    "command": {
                      "type": "string"
                    },
                    "aksCluster": {
                      "type": "string"
                    },
                    "variables": {
                      "type": "array",
                      "items": {
                        "$ref": "#/definitions/variable"
                      }
                    },
                    "subnetName": {
                      "type": "string"
                    },
                    "shellIdentity": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    },
                    "dryRun": {
                      "type": "object",
                      "additionalProperties": false,
                      "properties": {
                        "command": {
                          "type": "string"
                        },
                        "variables": {
                          "type": "array",
                          "items": {
                            "$ref": "#/definitions/variable"
                          }
                        }
                      }
                    }
                  },
                  "required": [
                    "command"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "DelegateChildZone"
                    },
                    "parentZone": {
                      "$ref": "#/definitions/value"
                    },
                    "childZone": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "parentZone",
                    "childZone"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "SetCertificateIssuer"
                    },
                    "vaultBaseUrl": {
                      "$ref": "#/definitions/value"
                    },
                    "issuer": {
                      "$ref": "#/definitions/value"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "applicationId": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "vaultBaseUrl",
                    "issuer",
                    "secretKeyVault",
                    "secretName",
                    "applicationId"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "CreateCertificate"
                    },
                    "vaultBaseUrl": {
                      "$ref": "#/definitions/value"
                    },
                    "certificateName": {
                      "$ref": "#/definitions/value"
                    },
                    "contentType": {
                      "$ref": "#/definitions/value"
                    },
                    "san": {
                      "$ref": "#/definitions/value"
                    },
                    "issuer": {
                      "$ref": "#/definitions/value"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "applicationId": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "vaultBaseUrl",
                    "certificateName",
                    "contentType",
                    "san",
                    "issuer",
                    "secretKeyVault",
                    "secretName",
                    "applicationId"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "ResourceProviderRegistration"
                    },
                    "resourceProviderNamespaces": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "resourceProviderNamespaces"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "Kusto"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "applicationId": {
                      "$ref": "#/definitions/value"
                    },
                    "connectionString": {
                      "$ref": "#/definitions/value"
                    },
                    "command": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "secretKeyVault",
                    "secretName",
                    "applicationId",
                    "connectionString",
                    "command"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "Pav2"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "storageAccount": {
                      "$ref": "#/definitions/value"
                    },
                    "smeEndpointSuffixParameter": {
                      "$ref": "#/definitions/value"
                    },
                    "smeAppidParameter": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "secretKeyVault",
                    "secretName",
                    "storageAccount",
                    "smeEndpointSuffixParameter",
                    "smeAppidParameter"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "type": "string",
                      "enum": [
                        "RPLogsAccount",
                        "ClusterLogsAccount"
                      ]
                    },
                    "typeName": {
                      "$ref": "#/definitions/value"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "environment": {
                      "$ref": "#/definitions/value"
                    },
                    "accountName": {
                      "$ref": "#/definitions/value"
                    },
                    "metricsAccount": {
                      "$ref": "#/definitions/value"
                    },
                    "adminAlias": {
                      "$ref": "#/definitions/value"
                    },
                    "adminGroup": {
                      "$ref": "#/definitions/value"
                    },
                    "subscriptionId": {
                      "$ref": "#/definitions/value"
                    },
                    "namespace": {
                      "$ref": "#/definitions/value"
                    },
                    "certsan": {
                      "$ref": "#/definitions/value"
                    },
                    "certdescription": {
                      "$ref": "#/definitions/value"
                    },
                    "configVersion": {
                      "$ref": "#/definitions/value"
                    },
                    "events": {
                      "type": "object",
                      "description": "A map of event configurations where keys represent the fluent bit tag and values are their corresponding Geneva table name. Refer to https://eng.ms/docs/products/geneva/collect/instrument/linux/fluentd for details",
                      "patternProperties": {
                        "^.*$": {
                          "type": "string",
                          "description": "Geneva table name for the corresponding fluent bit tag"
                        }
                      },
                      "additionalProperties": false
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "typeName",
                    "secretKeyVault",
                    "secretName",
                    "environment",
                    "accountName",
                    "metricsAccount",
                    "adminAlias",
                    "adminGroup",
                    "subscriptionId",
                    "namespace",
                    "certsan",
                    "certdescription",
                    "configVersion",
                    "events"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "ImageMirror"
                    },
                    "targetACR": {
                      "$ref": "#/definitions/value"
                    },
                    "sourceRegistry": {
                      "$ref": "#/definitions/value"
                    },
                    "repository": {
                      "$ref": "#/definitions/value"
                    },
                    "digest": {
                      "$ref": "#/definitions/value"
                    },
                    "pullSecretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "pullSecretName": {
                      "$ref": "#/definitions/value"
                    },
                    "shellIdentity": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "targetACR",
                    "sourceRegistry",
                    "repository",
                    "digest",
                    "pullSecretKeyVault",
                    "pullSecretName",
                    "shellIdentity"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "FeatureRegistration"
                    },
                    "providerConfigRef": {
                      "$ref": "#/definitions/configRef"
                    },
                    "secretKeyVault": {
                      "$ref": "#/definitions/value"
                    },
                    "secretName": {
                      "$ref": "#/definitions/value"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "secretKeyVault",
                    "secretName",
                    "providerConfigRef"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "ProviderFeatureRegistration"
                    },
                    "providerConfigRef": {
                      "$ref": "#/definitions/configRef"
                    },
                    "identityFrom": {
                      "$ref": "#/definitions/input"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "providerConfigRef",
                    "identityFrom"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "SecretSync"
                    },
                    "configurationFile": {
                      "type": "string",
                      "minLength": 1
                    },
                    "encryptionKey": {
                      "type": "string",
                      "minLength": 1
                    },
                    "keyVault": {
                      "type": "string",
                      "minLength": 1
                    },
                    "identityFrom": {
                      "$ref": "#/definitions/input"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "configurationFile",
                    "encryptionKey",
                    "keyVault",
                    "identityFrom"
                  ]
                },
                {
                  "additionalProperties": false,
                  "properties": {
                    "name": {
                      "$ref": "#/definitions/stepName"
                    },
                    "action": {
                      "const": "Ev2Registration"
                    },
                    "identityFrom": {
                      "$ref": "#/definitions/input"
                    },
                    "dependsOn": {
                      "$ref": "#/definitions/stepDependencies"
                    }
                  },
                  "required": [
                    "identityFrom"
                  ]
                }
              ],
              "required": [
                "name",
                "action"
              ]
            }
          },
          "aksCluster": {
            "description": "Deprecated, to be removed",
            "type": "string"
          }
        },
        "required": [
          "name",
          "resourceGroup",
          "subscription",
          "steps"
        ]
      }
    },
    "buildStep": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "command": {
          "type": "string"
        },
        "args": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  },
  "required": [
    "serviceGroup",
    "rolloutName",
    "resourceGroups"
  ]
}